<?php

/**
 * @file
 * Contains va_gov_backend.module.
 */

use Drupal\Core\Asset\AttachedAssetsInterface;
use Drupal\Core\Entity\EntityFormInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Field\WidgetBase;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\node\NodeInterface;
use Drupal\taxonomy\Entity\Term;
use Drupal\user\Entity\Role;
use Drupal\user\RoleInterface;
use Drupal\va_gov_build_trigger\Form\PreviewForm;
use Symfony\Cmf\Component\Routing\RouteObjectInterface;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * Implements hook_help().
 */
function va_gov_backend_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the va_gov_form_helper module.
    case 'help.page.va_gov_form_helper':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>Tools to improve backend user experience for VA.gov</p>';
      $output .= '<ul>';
      $output .= '<li>Hide Trigger Text field in Alert paragraph form unless Alert Type is Expanding</li>';
      $output .= '</ul>';
      return $output;

    default:
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Get our role descriptions.
 */
function va_gov_backend_form_user_form_alter(array &$form) {
  if (isset($form['account']['roles'])) {
    foreach (Role::loadMultiple() as $id => $role) {
      if ($role instanceof RoleInterface) {
        $form['account']['roles'][$id]['#description'] = $role->getThirdPartySetting('va_gov_backend', 'vgb_description');
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Set our role descriptions.
 */
function va_gov_backend_form_user_role_form_alter(array &$form, FormStateInterface $form_state) {
  $role = $form_state->getFormObject()->getEntity();
  $form['vgb_description'] = [
    '#type' => 'textfield',
    '#title' => t('Description'),
    '#description' => t('Additional relevant information about this role, such as where it is used and what it is for.'),
    '#default_value' => $role->getThirdPartySetting('va_gov_backend', 'vgb_description'),
    '#weight' => 1,
  ];

  $form['#entity_builders'][] = 'va_gov_backend_form_user_role_form_builder';
}

/**
 * Entity builder for the role configuration entity.
 *
 * @param string $entity_type
 *   The name of the entity_type.
 * @param Drupal\user\Entity\Role $role
 *   Instance of Role class.
 * @param array $form
 *   The node form array.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   Instance of FormStateInterface.
 *
 *   Saves our description field input.
 */
function va_gov_backend_form_user_role_form_builder($entity_type, Role $role, array &$form, FormStateInterface $form_state) {
  if ($form_state->getValue('vgb_description')) {
    $role->setThirdPartySetting('va_gov_backend', 'vgb_description', $form_state->getValue('vgb_description'));
    return;
  }

  $role->unsetThirdPartySetting('va_gov_backend', 'vgb_description');
}

/**
 * Implements hook_element_info_alter().
 */
function va_gov_backend_element_info_alter(array &$info) {
  if (isset($info['datetime'])) {
    $info['datetime']['#process'][] = 'va_gov_backend_datetime_set_format';
  }
}

/**
 * Element process callback for datetime fields.
 */
function va_gov_backend_datetime_set_format($element) {
  // Remove seconds in browsers that support HTML5 type=date.
  // Safe to use in all contexts - does not change timestamp storage.
  // Does not result in form validation errors.
  $element['time']['#attributes']['step'] = 60;
  return $element;
}

/**
 * After-build callback for press release address field.
 */
function va_gov_backend_press_release_address_after_build(array $element, FormStateInterface $form_state) {
  // Require the country to be selected.
  $element[0]['address']['country_code']['country_code']['#required'] = TRUE;
  unset($element[0]['address']['country_code']['country_code']['#options']['']);
  return $element;
}

/**
 * Implements hook_form_FORMID_alter().
 */
function va_gov_backend_form_views_exposed_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  if ($form['#id'] === 'views-exposed-form-health-service-offerings-service-offerings-dash') {
    // Change our textfield to a dropdown displaying all VAMC systems.
    _va_gov_backend_add_vamc_regions_select($form);
  }
}

/**
 * A Change text input to select list of VAMC systems.
 *
 * @param array $form
 *   The exposed widget form array.
 */
function _va_gov_backend_add_vamc_regions_select(array &$form) {
  // Query nodes.
  $storage = Drupal::getContainer()->get('entity_type.manager')->getStorage('node');
  $nids = $storage->getQuery();

  // Gather vamc nodes and sort by title.
  $nids = $nids->condition('type', 'health_care_region_page')
    ->sort('title')
    ->execute();

  // If there are no nodes, move on.
  if (!$nids) {
    return FALSE;
  }

  // Start building out the options for our select list.
  $options = [];
  $nodes = $storage->loadMultiple($nids);

  // Push titles into select list.
  foreach ($nodes as $node) {
    $options[$node->getTitle()] = $node->getTitle();
  }

  // Start building out our replacement form element.
  $form['title']['#type'] = 'select';
  $form['title']['#multiple'] = FALSE;

  // Specify the empty option for our select list.
  $form['title']['#empty_option'] = t('VAMC');

  // Add the $options from above to our select list.
  $form['title']['#options'] = $options;
  unset($form['title']['#size']);
}

/**
 * Implements hook_form_alter().
 */
function va_gov_backend_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  // Disable path alias modification after lc node is published.
  _va_gov_disable_alias_widget($form, $form_state);

  // Add states + custom validation if the Standalone Page field is present.
  if (isset($form['field_standalone_page'])) {
    $form['field_primary_category']['widget']['#states']['required']['input[id="edit-field-standalone-page-value"]'] = ['checked' => TRUE];
    $form['field_tags']['widget'][0]['subform']['field_topics']['#states']['required']['input[id="edit-field-standalone-page-value"]'] = ['checked' => TRUE];

    foreach ($form['field_buttons']['widget'] as $idx => $val) {
      if (is_numeric($idx)) {
        $form['field_buttons']['widget'][$idx]['subform']['field_button_label']['widget'][0]['value']['#states']['required']['input[id="edit-field-standalone-page-value"]'] = ['checked' => TRUE];
        $form['field_buttons']['widget'][$idx]['subform']['field_button_link']['widget'][0]['uri']['#states']['required']['input[id="edit-field-standalone-page-value"]'] = ['checked' => TRUE];
      }
    }

    // Add custom validation.
    array_unshift($form['#validate'], '_va_gov_backend_standalone_page_validation');
  }
  else {
    // Mark CTA button fields as required.
    if (!empty($form['field_buttons'])) {
      foreach ($form['field_buttons']['widget'] as $idx => $val) {
        if (is_numeric($idx)) {
          $form['field_buttons']['widget'][$idx]['subform']['field_button_label']['widget'][0]['value']['#required'] = TRUE;
          $form['field_buttons']['widget'][$idx]['subform']['field_button_link']['widget'][0]['uri']['#required'] = TRUE;
        }
      }
    }
  }

  // If Contact Information paragraph component.
  if (isset($form['field_contact_information'])) {
    $form['#validate'][] = '_va_gov_backend_contact_information_validation';
  }

  // Add custom behavior for Audience & Topics paragraph form.
  if (isset($form['field_tags'])) {
    // Add custom validation.
    $form['#validate'][] = '_va_gov_backend_audience_topics_validation';
    // Add the helper JS library.
    $form['field_tags']['widget']['#attached']['library'][] = 'va_gov_backend/audience_topics';
  }
  if (isset($form['field_datetime_range_timezone'])) {
    _va_gov_backend_smart_date_formatting($form, $form_state);
  };

  $targets = [
    'field_office',
    'field_listing',
  ];

  _va_gov_backend_dropdown_field_access($form, $targets);

  if ($form_id === 'workbench_access_assign_user') {
    $form['#submit'][] = 'va_gov_backend_workbench_assign_user_form_submit';
  }

  if ($form_id === 'redirect_redirect_edit_form' || $form_id === 'redirect_redirect_form') {
    $value = 'prefix';
    if ($form_id === 'redirect_redirect_edit_form') {
      $src_path = $form['redirect_source']['widget'][0]['path']['#default_value'];
      $connection = \Drupal::database()->select('redirect', 'r');
      $connection->fields('r', ['redirect_redirect__options']);
      $connection->condition('r.redirect_source__path', $src_path, '=');
      $query = unserialize($connection->execute()->fetchField());
      $value = !empty($query['matchType']) ? $query['matchType'] : '';
    }
    $form['redirect_match_type'] = [
      '#type' => 'select',
      '#options' => [
        'prefix' => 'prefix',
        'exact_match' => 'exact match',
        'regex_case_sensitive' => 'regex case sensitive',
        'regex_case_insensitive' => 'regex case insensitive',
        'non_re' => 'non re',
      ],
      '#title' => t('Match Type'),
      '#default_value' => $value,
    ];
    $form['actions']['submit']['#submit'][] = 'va_gov_backend_form_alter_redirect_submit';
  }

  if ($form_id === 'node_vamc_operating_status_and_alerts_edit_form') {
    // Hide field_office for existing operating statuses: they won't be moved.
    // @todo Consider disabling it instead of hiding it.
    $form['field_office']['#attributes']['class'] = 'hidden';
  }

  if ($form_id === 'views_bulk_operations_configure_action') {
    $build_info = $form_state->getBuildInfo();
    // We need to target only the VBO "Modify field values" form from
    // Facility Status tool.
    if ($build_info['args'][0] === 'facility_governance' && $build_info['args'][1] === 'page_1') {
      _va_gov_backend_vbo_facility_status_form_ui($form, $form_state);
    }
  }

  // Add to node forms in workflow.
  if (in_array('node_form', (array) $form['#theme'])) {
    $form['actions']['preview'] = [
      '#ief_submit_trigger' => TRUE,
      '#ief_submit_trigger_all' => TRUE,
      '#type' => 'submit',
      '#weight' => 10,
      '#value' => 'Save draft and continue editing',
      '#submit' => ['::submitForm', 'va_gov_backend_form_alter_submit'],
    ];

    // Remove the default preview button from types not in workflow.
    $node_type = $form_state->getFormObject()->getEntity()->getType();
    $types_in_workflow = \Drupal::entityTypeManager()->getStorage('workflow')->load('editorial')->get('type_settings')['entity_types']['node'];
    if (!in_array($node_type, $types_in_workflow)) {
      unset($form['actions']['preview']);
    }

  }

  // Add after_build callback for Press Release node forms.
  if ($form_id === 'node_press_release_form' || $form_id === 'node_press_release_edit_form') {
    $form['field_address']['widget']['#after_build'][] = 'va_gov_backend_press_release_address_after_build';
  }

}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter() for moderation_state widgets.
 */
function va_gov_backend_field_widget_moderation_state_default_form_alter(&$element, FormStateInterface $form_state, $context) {
  // Permit publication only from the proofing page, not the edit form.
  $base_form_id = $form_state->getBuildInfo()['base_form_id'];
  if ($base_form_id === 'node_form') {
    unset($element['state']['#options']['published']);
  }
}

/**
 * Returns the content types that need alias locked upon publish.
 *
 * @return array
 *   Node types that should have their alias locked upon publishing.
 */
function _va_gov_backend_get_locked_alias_bundles() {

  return [
    'basic_landing_page',
    'checklist',
    'faq_multiple_q_a',
    'media_list_images',
    'media_list_videos',
    'q_a',
    'step_by_step',
    'support_resources_detail_page',
    'va_form',
  ];
}

/**
 * Disable url alias widget after publish.
 *
 * @param array $form
 *   The node form array.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   Instance of FormStateInterface.
 */
function _va_gov_disable_alias_widget(array &$form, FormStateInterface $form_state) {
  if ($form_state->getFormObject() instanceof EntityFormInterface) {
    $bundle = $form_state->getformObject()->getEntity()->bundle();
    if (in_array($bundle, _va_gov_backend_get_locked_alias_bundles())) {
      $entity_id = $form_state->getformObject()->getEntity()->id();
      if (!empty($entity_id)) {
        $entity = \Drupal::entityTypeManager()->getStorage('node')->load($entity_id);
        // If it's published the alias widget is unchecked
        // to disallow auto path updating.
        if ($entity->isPublished() === TRUE) {
          $form['#after_build'][] = '_va_gov_backend_node_after_build_uncheck_auto_alias';
        }
      }
    }
  }
}

/**
 * Uncheck the auto pathalias checkbox.
 *
 * @param array $form
 *   The node form array.
 *
 * @return array
 *   The $form.
 */
function _va_gov_backend_node_after_build_uncheck_auto_alias(array $form) {
  // Unchecks the checkbox for pathauto.
  $form['path']['widget'][0]['pathauto']['#checked'] = FALSE;

  return $form;
}

/**
 * Custom validation callback for the audience_topics paragraph type.
 *
 * @param array $form
 *   The exposed widget form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _va_gov_backend_audience_topics_validation(array $form, FormStateInterface &$form_state) {
  if (!empty($form_state->getValue('field_tags'))) {

    // The tags field is not required if the Standalone Page field
    // is present and not checked.
    if (!empty($form['field_standalone_page']) && empty($form_state->getValue('field_standalone_page')['value'])) {
      return;
    }

    // Ensure that at least 1 and no more than 4 tags are selected
    // between the Topic and Audience fields.
    $tag_count = 0;

    if (isset($form_state->getValue('field_tags')[0])) {
      $tags_paragraph_values = $form_state->getValue('field_tags')[0];

      // Account for the fact that it's possible to select 'N/A'
      // for the beneficiary value.
      if (!empty($tags_paragraph_values['subform']['field_audience_beneficiares'][0]['target_id'])) {
        $tag_count += 1;
      }
      if (!empty($tags_paragraph_values['subform']['field_topics'])) {
        $tag_count += count($tags_paragraph_values['subform']['field_topics']);
      }
    }

    if ($tag_count == 0) {
      $form_state->setErrorByName('field_tags][0][subform][field_topics', t('Please select at least one Topic or Audience tag.'));
    }
    elseif ($tag_count > 4) {
      $form_state->setErrorByName('field_tags][0][subform][field_topics', t('No more than 4 Topic/Audience tags may be selected.'));
    }
  }
}

/**
 * Custom validation callback for the primary category field.
 *
 * @param array $form
 *   The exposed widget form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _va_gov_backend_standalone_page_validation(array &$form, FormStateInterface &$form_state) {
  if (!empty($form_state->getValue('field_standalone_page')['value'])) {
    if (empty($form_state->getValue('field_primary_category'))) {
      $form['field_primary_category']['#required'] = TRUE;
      $form_state->setErrorByName('field_primary_category', t('Primary category field is required.'));
    }
  }
}

/**
 * For formatting smart_date widget treatment.
 *
 * @param array $form
 *   The node form.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The node form state.
 */
function _va_gov_backend_smart_date_formatting(array &$form, FormStateInterface $form_state) {
  $form_object = $form_state->getFormObject();
  $type = $form_object->getEntity()->getEntityType()->id();
  $bundle = $form_object->getEntity()->bundle();
  // Move the help text from the bottom of the widget to the top.
  $definitions = \Drupal::service('entity_field.manager')->getFieldDefinitions($type, $bundle);
  $description = !empty($definitions['field_datetime_range_timezone']) ? $definitions['field_datetime_range_timezone']->get('description') : '';
  $form['field_datetime_range_timezone']['widget'][0]['value']['#prefix'] = '<div class="description">' . $description . '</div>';
  unset($form['field_datetime_range_timezone']['widget'][0]['#description']);
  // Only show start time unless event.
  if ($bundle !== 'event') {
    $form['field_datetime_range_timezone']['widget'][0]['end_value']['#attributes']['class'][] = 'hidden';
    $form['field_datetime_range_timezone']['widget'][0]['duration']['#attributes']['class'][] = 'hidden';
    unset($form['field_datetime_range_timezone']['widget'][0]['duration']['#title']);
    unset($form['field_datetime_range_timezone']['widget'][0]['end_value']['#title']);
    unset($form['field_datetime_range_timezone']['widget'][0]['value']['#title']);
  }
}

/**
 * Adds Validation to check for an empty entity reference field.
 *
 * @param array $form
 *   The exposed widget form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _va_gov_backend_contact_information_validation(array $form, FormStateInterface &$form_state) {
  // If contact information array and fields exist.
  if (!empty($form_state->getValue('field_contact_information')) && !empty($form_state->getValue('field_contact_information')[0]['subform']['field_contact_info_switch']) && !empty($form_state->getValue('field_contact_information')[0]['subform']['field_benefit_hub_contacts'])) {
    $contact_type = $form_state->getValue('field_contact_information')[0]['subform']['field_contact_info_switch'];
    $benefit_hub = $form_state->getValue('field_contact_information')[0]['subform']['field_benefit_hub_contacts'];
    $benefit_hub_contact = array_shift($benefit_hub);
  }

  // If the checkbox is checked.
  if ($contact_type[0]['value'] === 'BHC') {
    if (empty($benefit_hub_contact)) {
      $form_state->setErrorByName("field_contact_information][0][subform][field_benefit_hub_contacts", t('At least one benefit hub contact is required'));
    }
  }
}

/**
 * Submit function for va_gov_build_trigger_form_alter.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state array.
 */
function va_gov_backend_form_alter_submit(array &$form, FormStateInterface $form_state) {

  // We want to associate our user with the revision.
  $uid = Drupal::currentUser()->id();

  // Build the revision info.
  $node = $form_state->getFormObject()->getEntity();
  $node->setNewRevision(TRUE);
  $node->setRevisionCreationTime(\Drupal::time()->getRequestTime());

  // Save it and associate with user.
  $node->setRevisionUserId($uid);
  $node->set('moderation_state', 'draft');
  $node->save();

  $nid = $node->id();
  $url = 'http' . ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? 's' : '') . '://' . \Drupal::request()->getHost() . '/node/' . $nid . '/edit';

  // Send them to the edit node.
  $response = new RedirectResponse($url);
  $response->send();
}

/**
 * Prefix R&S vocabulary term page titles.
 */
function va_gov_backend_preprocess_page_title(&$variables) {
  $current_route_name = \Drupal::service('current_route_match')->getRouteName();
  if ($current_route_name === 'entity.taxonomy_term.canonical') {
    $term = \Drupal::request()->attributes->get('taxonomy_term');
    $vocabs = [
      'audience_beneficiaries',
      'audience_non_beneficiaries',
      'lc_categories',
      'topics',
    ];
    $vocab = $term->get('vid')->getString();
    if (in_array($vocab, $vocabs)) {

      $variables['title']['#markup'] = t('All articles in:') . ' ' . $variables['title']['#markup'];
    }
  }
}

/**
 * Add preview button to node view.
 */
function va_gov_backend_preprocess_page(&$variables) {

  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof NodeInterface) {
    // It's a node.
    $exclusion_types = [
      'documentation_page',
      'event_listing',
      'full_width_banner_alert',
      'health_care_local_health_service',
      'health_services_listing,',
      'leadership_listing',
      'locations_listing',
      'outreach_asset',
      'press_releases_listing',
      'regional_health_care_service_des',
      'support_service',
      'story_listing',
    ];
    // Make sure we aren't on the node form or an excluded type.
    $route_name = \Drupal::routeMatch()->getRouteName();
    if (($route_name !== 'entity.node.edit_form') &&
      (!in_array($node->bundle(), $exclusion_types))) {
      // Make sure we aren't on /training-guide.
      $current_uri = \Drupal::request()->getRequestUri();
      if ($current_uri !== '/training-guide') {
        $node = \Drupal::routeMatch()->getParameter('node');
        $nid = $node->id();
        $host = \Drupal::request()->getHost();
        $preview_form = new PreviewForm();
        $url = $preview_form->getEnvironment($host, $nid);
        $button = '<a class="button button--primary js-form-submit form-submit node-preview-button" target="_blank" href="' . $url . '">Preview</a>';
        $variables['page']['sidebar_second']['#markup'] = $button;
      }
    }
  }
}

/**
 * Modifies UI of the Facility Status VBO Modify Field Values form.
 *
 * The form that allows the user to modify field values contains too many
 * options that are irrelevant to the primary purpose of the tool. This
 * function modifies the form to eliminate UI noise.
 *
 * @param array $form
 *   Form object.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   Form state.
 */
function _va_gov_backend_vbo_facility_status_form_ui(array &$form, FormStateInterface $form_state) {
  // This if Facility Status form.
  // Clean up the UI.
  $bundle_fields = [];
  $entity_data = (isset($form['node']) && is_array($form['node'])) ? $form['node'] : NULL;

  if (!empty($entity_data)) {
    foreach ($entity_data as $bundle => $data) {
      if (is_array($data)) {
        $bundle_fields[$bundle] = $data;
      }
    }
  }

  foreach ($bundle_fields as $bundle => $fields) {
    if (is_array($fields)) {
      foreach ($fields as $field_name => $field_meta) {
        $form['node'][$bundle]['#open'] = TRUE;
        if (!in_array($field_name, ['field_operating_status_facility', 'field_operating_status_more_info']) && strpos($field_name, '#', 0) === FALSE) {
          // Remove all facility content type fields that are not related
          // to Operating status and Op info from field_selection form.
          unset($form['node'][$bundle]['_field_selector'][$field_name]);

          if (strpos($field_name, '_field_selector', 0) === FALSE) {
            // Remove all facility content type fields that are not related
            // to Operating status and Op info from vbo content type form.
            unset($form['node'][$bundle][$field_name]);
          }
        }
      }
    }
  }

  // Remove multi-value field options, since none of the fields we're editing
  // are multi-value.
  unset($form['options']);
}

/**
 * Callback handler for workbench_access_assign_user form - invalidate cache.
 *
 * @param array $form
 *   The workbench_access_assign_user form.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   Provides an interface for an object containing the current state of a form.
 */
function va_gov_backend_workbench_assign_user_form_submit(array $form, FormStateInterface $form_state) {
  $raw_path_to_args = $form_state->getBuildInfo()['args'];
  $path_to_args = reset($raw_path_to_args);
  $user_id = $path_to_args->id();
  $tags = ['user:' . $user_id];
  \Drupal::service('cache_tags.invalidator')->invalidateTags($tags);
}

/**
 * For determining dropdown field access on nodeforms.
 *
 * @param array $form
 *   The node form.
 * @param array $targets
 *   The node form fields to check.
 */
function _va_gov_backend_dropdown_field_access(array &$form, array $targets) {
  $user_id = \Drupal::currentUser()->id();
  $perms_service = \Drupal::service('va_gov_user.user_perms');
  // Grabs items user can access per section associations.
  $allowed_options = $perms_service->userOptionsStorage($form, $targets, $user_id);

  // Loop through all of our target fields.
  foreach ($targets as $target) {
    if (in_array($target, $form) && !empty($form[$target]['widget']['#options'])) {
      foreach ($form[$target]['widget']['#options'] as $header_key => $option_header) {
        // Field_listing is an exception. It is a one level field and doesn't
        // have opt groups.
        if ($target === 'field_listing' && !is_array($option_header) && !empty($option_header)) {
          // If not in the allowed items array, take it out.
          if (!in_array($header_key, $allowed_options)) {
            unset($form[$target]['widget']['#options'][$header_key]);
          }
        }
        elseif (is_array($option_header) && !empty($option_header)) {
          foreach ($option_header as $option_key => $option_item) {
            // If not in the allowed items array, take it out.
            if (!in_array($option_key, $allowed_options)) {
              unset($form[$target]['widget']['#options'][$header_key][$option_key]);
            }
          }
        }
      }
    }
  }
}

/**
 * Redirect form alter submit handler to store redirect Match Type.
 */
function va_gov_backend_form_alter_redirect_submit($form, FormStateInterface $form_state) {
  $connection = \Drupal::database();
  $src_path = reset($form_state->getValue('redirect_source', 'path'));
  $match_type = $form_state->getValue('redirect_match_type', 'path');
  $type = ['matchType' => $match_type];
  $converted = serialize($type);
  $connection->update('redirect')
    ->fields(['redirect_redirect__options' => $converted])
    ->condition('redirect_source__path', $src_path, '=')
    ->execute();
}

/**
 * For formatting smart_date paragraph field widget treatment.
 *
 * @param array $element
 *   The paragraph form.
 *
 *   Removes date range end field elements not relevant to situation updates.
 */
function _va_gov_backend_smart_date_paragraph_formatting(array &$element) {
  unset($element['subform']['field_datetime_range_timezone']['widget'][0]['#description']);
  $element['subform']['field_datetime_range_timezone']['widget'][0]['end_value']['#attributes']['class'][] = 'hidden';
  $element['subform']['field_datetime_range_timezone']['widget'][0]['duration']['#attributes']['class'][] = 'hidden';
  unset($element['subform']['field_datetime_range_timezone']['widget'][0]['duration']['#title']);
  unset($element['subform']['field_datetime_range_timezone']['widget'][0]['end_value']['#title']);
  unset($element['subform']['field_datetime_range_timezone']['widget'][0]['value']['#title']);
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function va_gov_backend_field_widget_paragraphs_form_alter(&$element, FormStateInterface $form_state, $context) {
  // Hide Trigger Text in Alert paragraph form unless Alert Type is "Expanding".
  $field_definition = $context['items']->getFieldDefinition();
  /**
   * @var \Drupal\field\Entity\FieldConfig $field_definition */
  $paragraph_entity_reference_field_name = $field_definition->getName();

  $target_paragraph_ref_fields = [
    'field_content_block',
    'field_service_location',
    'field_situation_updates',
  ];

  if (in_array($paragraph_entity_reference_field_name, $target_paragraph_ref_fields)) {
    $widget_state = WidgetBase::getWidgetState($element['#field_parents'], $paragraph_entity_reference_field_name, $form_state);

    $paragraph_instance = $widget_state['paragraphs'][$element['#delta']]['entity'];
    $paragraph_type = $paragraph_instance->bundle();

    if ($paragraph_type === 'situation_update') {
      _va_gov_backend_smart_date_paragraph_formatting($element);
    }
    if ($paragraph_type == 'alert') {
      $selector = sprintf(':input[name="%s[%d][subform][%s]"]', $paragraph_entity_reference_field_name, $element['#delta'], 'field_alert_type');

      $element['subform']['field_alert_trigger_text']['#states'] = [
        'visible' => [
          $selector => ['value' => 'expanding'],
        ],
      ];
    }
    if ($paragraph_type === 'service_location') {
      if (!empty($element['subform']['field_facility_service_hours'])) {
        // Clean up the hours form and remove redundant labels.
        unset($element['subform']['field_facility_service_hours']['widget'][0]['#title']);
        unset($element['subform']['field_facility_service_hours']['widget'][0]['#description']);
        // Don't show additional hours field unless custom hours are input.
        $selector = sprintf(':input[name="field_service_location[%d][subform][field_hours]"]', $element['#delta']);
        $element['subform']['field_additional_hours_info']['#states'] = [
          'visible' => [
            $selector => ['value' => '2'],
          ],
        ];
      }
    }
  }

  // If we have a field ref'ing service location paragraphs, fire function.
  $vha_paragraphs = [
    'field_service_location',
    'field_service_location_address',
    'field_phone_numbers_paragraph',
    'field_phone',
  ];
  if (in_array($paragraph_entity_reference_field_name, $vha_paragraphs)) {
    _va_gov_backend_modify_paragraph_interactions($element, $form_state, $context, $paragraph_entity_reference_field_name);
  }
}

/**
 * Implements hook_field_widget_entity_reference_paragraphs_form_alter().
 */
function va_gov_backend_field_widget_entity_reference_paragraphs_form_alter(&$element, FormStateInterface $form_state, $context) {
  _va_gov_backend_modify_alert_single_states($element, $form_state, $context);
  _va_gov_backend_modify_contact_information_states($element, $form_state, $context);
}

/**
 * Toggle Reusable and Non-reusable Alert_Single subform fields.
 *
 * Adds Validation constraint error id match to html.
 *
 * @param array $element
 *   The widget.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 * @param array $context
 *   The context.
 */
function _va_gov_backend_modify_alert_single_states(array &$element, FormStateInterface &$form_state, array &$context) {
  // Toggle Reusable & Non-reusable Alert_Single subform field on alert select.
  if ($element['#paragraph_type'] === 'alert_single') {
    $element_path = $element['subform']['#parents'];
    $parent_field = array_shift($element_path);
    $element_path_string = implode('][', $element_path);
    // Confirming element path exists before applying states logic to fields.
    if (!empty($parent_field) && !empty($element_path_string)) {
      $selector = ':input[name="' . $parent_field . '[' . $element_path_string . '][field_alert_selection]"]';

      $element['subform']['field_alert_block_reference']['#states'] = [
        'visible' => [
          [$selector => ['value' => 'R']],
        ],
      ];

      $element['subform']['field_alert_non_reusable_ref']['#states'] = [
        'visible' => [
          [$selector => ['value' => 'NR']],
        ],
      ];
    }
  }
}

/**
 * Toggle Default Contact and Benefit Hub Contacts subform fields.
 *
 * Adds Validation constraint error id match to html.
 *
 * @param array $element
 *   The widget.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 * @param array $context
 *   The context.
 */
function _va_gov_backend_modify_contact_information_states(array &$element, FormStateInterface &$form_state, array &$context) {
  // Toggle Default Contact and Benefit Hub Contacts subform fields.
  if ($element['#paragraph_type'] === 'contact_information') {
    $element_path = $element['subform']['#parents'];
    $parent_field = array_shift($element_path);
    $element_path_string = implode('][', $element_path);
    // Confirming element path exists before applying states logic to fields.
    if (!empty($parent_field) && !empty($element_path_string)) {
      $selector = ':input[name="' . $parent_field . '[' . $element_path_string . '][field_contact_info_switch]"]';

      $element['subform']['field_contact_default']['#states'] = [
        'visible' => [
          [$selector => ['value' => 'DC']],
        ],
      ];

      $element['subform']['field_benefit_hub_contacts']['#states'] = [
        'visible' => [
          [$selector => ['value' => 'BHC']],
        ],
      ];
    }
  }
}

/**
 * Toggles service_location fields depending on parent selector.
 *
 * Adds Validation constraint error id match to html.
 *
 * @param array $element
 *   The widget.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 * @param array $context
 *   The context.
 * @param string $paragraph_entity_reference_field_name
 *   The reference field name.
 */
function _va_gov_backend_modify_paragraph_interactions(array &$element, FormStateInterface &$form_state, array &$context, $paragraph_entity_reference_field_name) {
  $field_definition = $context['items']->getFieldDefinition();

  /**
   * @var \Drupal\field\Entity\FieldConfig $field_definition */
  $paragraph_entity_reference_field_name = $field_definition->getName();
  $widget_state = WidgetBase::getWidgetState($element['#field_parents'], $paragraph_entity_reference_field_name, $form_state);

  $paragraph_instance = $widget_state['paragraphs'][$element['#delta']]['entity'];
  $paragraph_type = $paragraph_instance->bundle();

  // Toggle hours fields depending on "Use facility hours" select.
  // field_service_location[0][subform][field_service_location_address][0][subform][field_use_facility_address][value].
  if ($paragraph_type === 'service_location') {
    // If use facility hours option is not selected, show address entry fields.
    $toggle_fields = [
      'field_facility_service_hours',
      'field_additional_hours_info',
    ];
    $selector = sprintf(':input[name="field_service_location[%1$d][subform][field_hours]"]', $element['#delta']);
    foreach ($toggle_fields as $field) {
      $element['subform'][$field]['#states'] = [
        'visible' => [
          $selector => ['value' => "2"],
        ],
      ];
    }
    // Remove catpion, rows, and import fields from address tablefield.
    if (isset($element['subform']['field_facility_service_hours']['widget'][0]['caption'])) {
      unset($element['subform']['field_facility_service_hours']['widget'][0]['caption']);
    }
    $element['subform']['field_facility_service_hours']['widget'][0]['prefix']['#markup'] = t('<div class="description">Format: "8:00 a.m. to 5:30 p.m. ET" or "24/7"</div>');
    $element['subform']['field_facility_service_hours']['widget'][0]['#import'] = FALSE;
    $element['subform']['field_facility_service_hours']['widget'][0]['#addrow'] = FALSE;
    $element['subform']['field_facility_service_hours']['widget'][0]['#rebuild'] = FALSE;
  }

}

/**
 * Implements hook_inline_entity_form_alter().
 */
function va_gov_backend_inline_entity_form_entity_form_alter(&$entity_form, FormStateInterface $form_state) {
  // Show the facility name so that the editor knows what they're editing,
  // but don't let the editor change it. It's driven by Facility API.
  if ($entity_form['#bundle'] === 'health_care_local_facility') {
    $entity_form['title']['widget'][0]['value']['#attributes']['disabled'] = 'disabled';
  }
}

/**
 * Implements hook_entity_bundle_field_info_alter().
 */
function va_gov_backend_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  // Add phone number validation to our phone number field.
  if ($entity_type->id() === 'paragraph' && $bundle === 'phone_number' && isset($fields['field_phone_number'])) {
    $fields['field_phone_number']->addConstraint('ValidPhoneNumber');
  }
  // Add title duplication prevention validation to q_a nodes.
  if ($entity_type->id() === 'node' && $bundle === 'q_a' && isset($fields['title'])) {
    $fields['title']->addConstraint('UniqueTitle');
  }
}

/**
 * Implements hook_page_attachments().
 */
function va_gov_backend_page_attachments(array &$attachments) {
  // Add GTM to cms theme.
  $attachments['#attached']['library'][] = 'va_gov_backend/gtm_tag_push';
  // Track GTM click events.
  $attachments['#attached']['library'][] = 'va_gov_backend/gtm_tag_trackers';

  // Pass our relevant data to settings.
  $attachments['#attached']['drupalSettings']['gtm_data'] = _va_gov_backend_gtm_settings();

  $attachments['#attached']['library'][] = 'va_gov_backend/alert_form';
  $attachments['#attached']['library'][] = 'va_gov_backend/system_styles';
  // Nested address, phone and email paragraphs result in multiple deltas.
  // Tracking this with states api gets messy.
  // Bypass and use behaviors directly.
  $attachments['#attached']['library'][] = 'va_gov_backend/service_location_address';
  $attachments['#attached']['library'][] = 'va_gov_backend/contact_paragraphs_interactions';

  // Handle smart_date widget treatments.
  $attachments['#attached']['library'][] = 'va_gov_backend/smart_date_interactions';

  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
  if ($is_admin) {
    // Add custom css for paragraph browser.
    $attachments['#attached']['library'][] = 'va_gov_backend/admin_styles';

    return;
  }
}

/**
 * Builds section associations for gtm push array.
 *
 * @return array
 *   Keyed array of the section item names.
 */
function _va_gov_backend_gtm_settings() {
  $sections = [];
  $current_path = \Drupal::service('path.current')->getPath();
  $request = \Drupal::request();
  // Grab our page title.
  if ($route = $request->attributes->get(RouteObjectInterface::ROUTE_OBJECT)) {
    $page_title = \Drupal::service('title_resolver')->getTitle($request, $route);
    $sections['pageTitle'] = $page_title;
  }
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof NodeInterface) {
    $route = \Drupal::routeMatch()->getRouteName();
    // If we are on node view, get the alias.
    if ($route === 'entity.node.canonical') {
      $current_path = $node->toUrl()->toString();
    }
    $sections['nodeID'] = $node->id();
    $sections['pageTitle'] = $node->getTitle();
    $sections['pagePath'] = $current_path;
    $sections['contentTitle'] = $node->getTitle();
    $sections['contentType'] = $node->bundle();

    if (property_exists($node, 'field_administration')) {
      $section_entity_id = $node->field_administration->getString();
      // Load up our section name.
      $section_entity_load = !empty($section_entity_load) ? Term::load($section_entity_id) : '';
      $sections['contentOwner'] = !empty($section_entity_load) ? $section_entity_load->getName() : '';
    }

  }
  return $sections;
}

/**
 * Implements hook_page_bottom().
 */
function va_gov_backend_page_bottom(array &$page_bottom) {
  // Add GTM noscript iframe to body.
  $env_name = \Drupal::config('environment_indicator.indicator')->get('name');
  $env_num = $env_name === 'Production' ? '2' : '5';
  $gtm_noscript = Markup::create('<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WQ3DLLB&gtm_auth=hHvHnY1eIx1IOSJMAnOBLA&gtm_preview=env-' . $env_num . '&gtm_cookies_win=x" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>');
  $page_bottom['va_gov_backend'] = ['#markup' => $gtm_noscript];
}

/**
 * Implements hook_local_tasks_alter().
 */
function va_gov_backend_menu_local_tasks_alter(&$local_tasks) {
  // Replace the View Json tab with the node view.
  $node = \Drupal::routeMatch()->getParameter('node');
  if ($node instanceof NodeInterface) {
    $nid = $node->id();
    $local_tasks['tabs'][0]['entity.node.canonical']['#link']['title'] = 'View';
    $local_tasks['tabs'][0]['entity.node.canonical']['#link']['url'] = Url::fromUri('internal:/node/' . $nid);
  }
  // Remove the history tab.
  if (!empty($local_tasks['tabs'][0]['views_view:view.moderation_history.page'])) {
    unset($local_tasks['tabs'][0]['views_view:view.moderation_history.page']);
  }
}

/**
 * Implements hook_mail_alter().
 */
function va_gov_backend_mail_alter(&$message) {
  $message['headers']['Sender'] = $message['headers']['From'];
}

/**
 * Implements hook_rebuild().
 */
function va_gov_backend_rebuild() {
  // Update the drupal state to display git info in admin toolbar.
  $environment = \Drupal::config('environment_indicator.indicator')->get('name');
  $branch = mb_strimwidth(exec('git rev-parse --abbrev-ref HEAD'), 0, 20, '...') ?? 'git unknown';
  $commit_hash = trim(exec('git rev-parse --short HEAD'));
  $git_tag = exec("git tag --points-at $commit_hash");
  // Remove the 'cms/' from the tag that looks like 'cms/v0.0.190'.
  $git_tag = str_replace('cms/v', '', $git_tag);

  $brd = [
    'Development',
    'Staging',
    'Production',
  ];

  if (($environment === 'Production') && !empty($git_tag)) {
    $indicator = "v{$git_tag}";
  }
  elseif (in_array($environment, $brd)) {
    // We are in a BRD environment but with no tag.
    $indicator = "v{$commit_hash}";
  }
  else {
    // We are in not in a BRD environment, so display branch and SHA.
    $indicator = "Branch: {$branch}  v{$commit_hash}";
  }

  \Drupal::state()->set("environment_indicator.current_release", $indicator);
}

/**
 * Implements hook_toolbar().
 *
 * Defines Branch component in Admin Toolbar Menu.
 */
function va_gov_backend_toolbar() {
  $items = [];
  $items['branch'] = [
    '#cache' => [
      'contexts' => ['user.permissions'],
    ],
    '#type' => 'toolbar_item',
    'tab' => [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#value' => \Drupal::state()->get("environment_indicator.current_release"),
      '#attributes' => [
        'title' => 'See https://github.com/department-of-veterans-affairs/va.gov-cms for more info.',
        'class' => ['toolbar-icon', 'toolbar-icon-branch'],
      ],
    ],
    '#wrapper_attributes' => [
      'class' => ['toolbar-tab', 'branch-toolbar-tab'],
    ],
    '#weight' => 100,
  ];

  return $items;
}

/**
 * Disable the search tool in the toolbar menu.
 */
function va_gov_backend_toolbar_alter(&$items) {
  if (!empty($items['administration_search'])) {
    unset($items['administration_search']);
  }

  // Hide environment indicator tab.
  //
  // We are adding the 'visually-hidden' class rather than removing the 'tab'
  // array element in order to prevent outputting empty links which cause the
  // accessibility tests to fail.
  if (!empty($items['environment_indicator']['tab'])) {
    $items['environment_indicator']['tab']['#attributes']['class'][] = 'visually-hidden';
  }
}

/**
 * Implements hook_css_alter().
 */
function va_gov_backend_css_alter(&$css, AttachedAssetsInterface $assets) {
  // Remove user_history css - not congruous with theme.
  $module_handler = \Drupal::service('module_handler');
  $module_path = $module_handler->getModule('user_history')->getPath();

  unset($css[$module_path . '/css/user_history.css']);
}

/**
 * Alter the pattern to be used before an alias is generated by Pathauto.
 *
 * This hook will only be called if a default pattern is configured (on
 * admin/config/search/path/patterns).
 *
 * @param string $alias
 *   The Pathauto pattern to be used.
 * @param array $context
 *   An associative array of additional options, with the following elements:
 *   - 'module': The module or entity type being aliased.
 *   - 'op': A string with the operation being performed on the object being
 *     aliased. Can be either 'insert', 'update', 'return', or 'bulkupdate'.
 *   - 'source': A string of the source path for the alias (e.g. 'node/1').
 *   - 'data': An array of keyed objects to pass to token_replace().
 *   - 'bundle': The sub-type or bundle of the object being aliased.
 *   - 'language': A string of the language code for the alias (e.g. 'en').
 *     This can be altered by reference.
 */
function va_gov_backend_pathauto_alias_alter(&$alias, array &$context) {
  /*
   * @todo
   * Remove this alter after converting VAMC events to outreach event
   * event_listing association pattern. This is a temporary fix to allow
   * for both methods to use same aliasing pattern.
   */

  if ($context['module'] === 'node' && ($context['bundle'] === 'event')) {
    $alias = str_replace('/events/events/', '/events/', $alias);
  }
}

/**
 * Implements hook_entity_presave().
 *
 * @todo: Remove node page wysiwyg sync after VACMS-1163 is on prod.
 */
function va_gov_backend_entity_presave(EntityInterface $entity) {
  $bundle_types = ['event', 'news_story', 'press_release', 'outreach_asset'];

  if ($entity->getEntityTypeId() === 'node' && in_array($entity->bundle(), $bundle_types)) {
    _va_gov_backend_feature_bump($entity);
  }

  if ($entity->getEntityTypeId() === 'node' && $entity->bundle() === 'page') {
    _va_gov_backend_sync_wysiwyg_fields($entity);
  }

  if ($entity->getEntityTypeId() === 'node' && in_array($entity->bundle(), _va_gov_backend_get_locked_alias_bundles())) {
    _va_gov_backend_disable_autopath_alias($entity);
  }
}

/**
 * Determine if pathauto alias should be enable on node.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The node to check for disabling pathauto alias pattern.
 */
function _va_gov_backend_disable_autopath_alias(EntityInterface $entity) {
  if (!$entity->isNew()) {
    // Get original values of the node for comparison.
    $original_use_alias_pattern = $entity->original->get('path')->pathauto;
    $current_use_alias_pattern = $entity->get('path')->pathauto;
    // Decide if this was an intentional toggle on of using the alias pattern.
    $toggled_on_this_save = $current_use_alias_pattern && !$original_use_alias_pattern;
    $active_entity = \Drupal::entityTypeManager()->getStorage('node')->load($entity->id());
    $published_previously = ($active_entity instanceof NodeInterface) ? $active_entity->isPublished() : FALSE;

    if ($published_previously && !$toggled_on_this_save) {
      // This was published and this was not an intentional toggle on.
      // Disable the pathauto pattern.
      $entity->path->pathauto = 0;
    }
  }
}

/**
 * Unfeature other items of same bundle in system.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   Entity.
 */
function _va_gov_backend_feature_bump(EntityInterface $entity) {
  // Check to see if this entity has a featured option.
  if (!empty($entity->field_featured)) {
    $status = $entity->field_featured->value;
    $bundle = $entity->bundle();
    $target = $entity->field_listing->target_id;
    // If this is our feature item, start the process.
    if ($status === 1) {
      // Look for all of same bundle in system that are also featured.
      $select = \Drupal::database()->select('node__field_featured', 'nff');
      $select->join('node__field_listing', 'nfl', 'nfl.entity_id = nff.entity_id');
      $select->fields('nff', ['entity_id'])
      // We don't want to operate on current node.
        ->condition('nff.entity_id', $entity->id(), '!=')
        ->condition('nff.field_featured_value', 1)
        ->condition('nfl.field_listing_target_id', $target)
        ->condition('nff.bundle', $bundle);
      $results = $select->execute()->fetchAllKeyed();
      // Better to use entity api than raw db query to get drupal magic.
      $nodes = \Drupal::entityTypeManager()->getStorage('node')->loadMultiple(array_keys($results));
      foreach ($nodes as $node) {
        // Set the others to unfeatured.
        $node->field_featured->value = 0;
        $node->save();
      }
    }
  }
}

/**
 * Sync field_intro_text with field_intro_text_limited_html.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   Entity.
 */
function _va_gov_backend_sync_wysiwyg_fields(EntityInterface $entity) {
  // Match the new intro field with the old intro field.
  if ($entity->hasField('field_intro_text_limited_html')) {
    $intro_text_field_data = $entity->field_intro_text->value;
    $entity->field_intro_text_limited_html->value = $intro_text_field_data;
    $entity->field_intro_text_limited_html->format = 'rich_text_limited';
  }
}

/**
 * Sets field_listing value or throws an exception for an empty value.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   Entity.
 * @param array $entity_listing_mapping
 *   Mapping that specifies how content type maps to corresponding
 *   "listing" content type.
 * @param int|null $id
 *   NID of the node of type "listing".
 *
 * @throws \Exception
 */
function _va_gov_backend_set_field_listing_value(EntityInterface &$entity, array $entity_listing_mapping, int $id = NULL) {
  if (!is_int($id) || $id == 0) {
    // Listing corresponding to field_office, was not found. Fail silently.
    // Give a warning message to the user and log in dblog.
    Drupal::messenger()->addWarning("{$entity->type->entity->label()} Listing page for the office or system you've selected does not exist. Please create {$entity->type->entity->label()} Listing page and come back to re-save this {$entity->type->entity->label()}.");
    Drupal::logger('va_gov_backend')->warning('%bundle Listing page for the office or system you\'ve selected does not exist. Please create %bundle Listing page and come back to re-save %bundle with NID %nid.', ['%bundle' => $entity->type->entity->label(), '%nid' => $entity->id()]);
    return;
  }

  // We have a listing node id.
  if ($entity->hasField('field_listing')) {
    // Clear previous value.
    $entity->set('field_listing', NULL);
    // Assuming there's only one Event Listing per Office/VAMC System.
    $entity->field_listing[] = ['target_id' => $id];
  }
}
