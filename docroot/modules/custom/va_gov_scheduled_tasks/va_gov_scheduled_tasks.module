<?php

/**
 * @file
 * Contains va_gov_scheduled_tasks.module.
 */

use Drupal\Core\File\FileSystemInterface;
use Drupal\Core\File\FileExists;
use Drupal\Core\StreamWrapper\PublicStream;

/**
 * Downloads the VA Forms data file and saves it for migration.
 */
function va_gov_scheduled_tasks_va_forms_csv_source() {
  $source_url = 'https://vaww.webdevi.va.gov/vaforms/VAForms_DataExtract/VAForms_FormsData.txt';
  $destination_dir_uri = PublicStream::basePath() . "/migrate_source";
  $destination_file_uri = $destination_dir_uri . '/va_forms_data.csv';

  /** @var \Drupal\Core\File\FileSystemInterface $file_system */
  $file_system = \Drupal::service('file_system');
  /** @var \GuzzleHttp\ClientInterface $http_client */
  $http_client = \Drupal::httpClient();

  // Ensure the destination directory exists, creating it if necessary.
  if (!$file_system->prepareDirectory($destination_dir_uri, FileSystemInterface::CREATE_DIRECTORY)) {
    // More detailed logging to find the root cause.
    $parent_dir = 'public://';
    $is_writable = is_writable($parent_dir);
    \Drupal::logger('va_gov_scheduled_tasks')->error('Could not create or access the destination directory: @dir. Is parent directory @parent writable? @writable', [
      '@dir' => $destination_dir_uri,
      '@parent' => $file_system->realpath($parent_dir),
      '@writable' => $is_writable ? 'Yes' : 'No',
    ]);
    return;
  }

  try {
    // Make the HTTP GET request. Guzzle follows redirects by default,
    // which handles the -L option from the curl command.
    $response = $http_client->request('GET', $source_url);

    if ($response->getStatusCode() === 200) {
      // Get the file contents from the response body.
      $file_contents = (string) $response->getBody();

      // Save the data to the destination file, replacing it if it exists.
      $file_system->saveData($file_contents, $destination_file_uri, FileExists::Replace);
      // Corrected logger channel for consistency.
      \Drupal::logger('va_gov_scheduled_tasks')->notice('Successfully downloaded and saved VA Forms data to @uri.', ['@uri' => $destination_file_uri]);
    }
    else {
      // Corrected logger channel for consistency.
      \Drupal::logger('va_gov_scheduled_tasks')->error('Failed to download VA Forms data. Received HTTP status: @status', ['@status' => $response->getStatusCode()]);
    }
  }
  catch (\Exception $e) {
    // Corrected logger channel for consistency.
    \Drupal::logger('va_gov_scheduled_tasks')->error('An exception occurred while trying to download VA Forms data: @message', ['@message' => $e->getMessage()]);
  }
}
