<?php

/**
 * @file
 * Contains va_gov_facilities.module.
 */

/**
 * Implements hook_page_attachments().
 */
function va_gov_facilities_page_attachments(array &$attachments) {
  // Control visibility/required for facility status details.
  $attachments['#attached']['library'][] = 'va_gov_facilities/facility_status_details';
}

/**
 * Implements hook_preprocess_HOOK().
 */
function vagovclaro_preprocess_field__paragraph__field_hours(&$variables) {
  $item_list = $variables['element']['#items'];
  $paragraph = $item_list->getEntity();
  $field_hours_value = $paragraph->get('field_hours')->value;
  if ($field_hours_value === "0") {
    $node_parent = _vagovclaro_get_node_parent($paragraph);
    $node_type = $node_parent->getType();
    $bundles_referencing_content = [
      'health_care_local_health_service',
      'vha_facility_nonclinical_service',
    ];
    if (in_array($node_type, $bundles_referencing_content)) {
      $viewBuilder = \Drupal::entityTypeManager()->getViewBuilder('node');
      // @phpstan-ignore-next-line Test is unclear what get() we are using
      $referenced_node = $node_parent->get('field_facility_location')->referencedEntities();
      $node_entity = $referenced_node[0];
      $value = $node_entity->get('field_office_hours');
      $output = $viewBuilder->viewField($value, 'full');
      $output['#cache']['tags'] = $node_entity->getCacheTags();
      $variables['actual_hours'] = $output;
    }
  }
}
