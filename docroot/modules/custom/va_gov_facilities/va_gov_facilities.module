<?php

/**
 * @file
 * Contains va_gov_facilities.module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;

/**
 * @file
 * Contains va_gov_facilities.module.
 */

/**
 * Implements hook_page_attachments().
 */
function va_gov_facilities_page_attachments(array &$attachments) {
  // Control visibility/required for facility status details.
  $attachments['#attached']['library'][] = 'va_gov_facilities/facility_status_details';
}

/**
 * Implements hook_preprocess_HOOK().
 */
function va_gov_facilities_preprocess_field__paragraph__field_hours(&$variables) {
  // The value of the "Use the facility's hours" choice.
  $use_facility_hours = "0";
  $item_list = $variables['element']['#items'];
  $paragraph = $item_list->getEntity();
  $field_name = "field_hours";
  if ($paragraph->$field_name->value === $use_facility_hours) {
    $node_parent = va_gov_backend_get_node_parent($paragraph);
    if ($node_parent) {
      $related_field = "field_facility_location";
      $field_to_render = "field_office_hours";
      $variables['actual_hours'] = _va_gov_facilities_create_custom_variable($node_parent, $related_field, $field_to_render);
    }
  }
}

/**
 * Creates custom array for render array.
 *
 * @param \Drupal\node\NodeInterface $node
 *   Node that relates to the one whose field we want to render.
 * @param string $related_field
 *   Field that relates our node to another.
 * @param string $field_to_render
 *   Field we want to render.
 *
 * @return array
 *   Render array
 */
function _va_gov_facilities_create_custom_variable(NodeInterface $node, $related_field, $field_to_render) {
  // @phpstan-ignore-next-line Test is unclear what get() we are using
  $referenced_node = $node->get($related_field)->referencedEntities();
  $output = [];
  if (isset($referenced_node[0])) {
    $node_entity = $referenced_node[0];
    $value = $node_entity->get($field_to_render);
    $output['content']['weight'] = 10;
    $output['#cache']['tags'] = $node_entity->getCacheTags();
    $viewBuilder = \Drupal::entityTypeManager()->getViewBuilder('node');
    $output = $viewBuilder->viewField($value, 'full');
  }
  return $output;
}

/**
 * Implements hook_field_widget_widget_complete_form_alter().
 */
function va_gov_facilities_field_widget_complete_form_alter(&$field_widget_complete_form, FormStateInterface $form_state, $context) {
  /** @var \Drupal\field\Entity\FieldConfig $field_definition */
  $field_definition = $context['items']->getFieldDefinition();
  $paragraph_entity_reference_field_name = $field_definition->getName();
  if ($paragraph_entity_reference_field_name === "field_service_location") {
    $item_list = $context['items'];
    $node = $item_list->getEntity();
    $related_field = "field_facility_location";
    $field_to_render = "field_office_hours";
    $widget_items = $field_widget_complete_form['widget'];
    $widget_list = [];
    for ($i = 0; isset($widget_items[$i]); $i++) {
      $widget_list[] = $widget_items[$i];
    }
    foreach ($widget_list as $index => $widget_list_item) {
      $field_widget_complete_form['widget'][$index]['subform']['field_hours']['facility_hours'] = _va_gov_facilities_create_custom_variable($node, $related_field, $field_to_render);

    }
  }
}
