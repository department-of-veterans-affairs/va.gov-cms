---
name: Build and Push Drupal Container to ECR and Deploy to Mirror

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Semver tag (vX.Y.Z) to build. Leave blank to use latest.'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'  # Only tags starting with v and containing two dots

# Add concurrency to prevent parallel executions
concurrency:
  group: drupal-mirror-container-build
  cancel-in-progress: false

permissions:
  id-token: write  # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.select_tag.outputs.IMAGE_TAG }}
      IS_VALID: ${{ steps.select_tag.outputs.is_valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Needed to list all tags for manual runs
      - name: Select and validate tag
        id: select_tag
        run: |
          set -e
          EVENT='${{ github.event_name }}'
          INPUT_TAG='${{ github.event.inputs.tag }}'
          if [ "$EVENT" = "workflow_dispatch" ]; then
            if [ -n "$INPUT_TAG" ]; then
              TAG="$INPUT_TAG"
              if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
                  echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
                  echo "is_valid=true" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "::error title=Invalid Tag::Provided tag $TAG does not exist in repository." >&2
                  echo "is_valid=false" >> $GITHUB_OUTPUT
                  exit 1
                fi
              else
                echo "::error title=Invalid Semver::Provided tag $TAG is not strict semver vX.Y.Z." >&2
                echo "is_valid=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              # No input tag; pick latest semver
              LATEST_TAG=$(git tag --list 'v*.*.*' --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
              if [ -z "$LATEST_TAG" ]; then
                echo "::error title=No Tags Found::No semver tags (vX.Y.Z) found in repository." >&2
                echo "is_valid=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              echo "Using latest semver tag: $LATEST_TAG"
              echo "IMAGE_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
              echo "is_valid=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            # Push tag event
            TAG="$GITHUB_REF_NAME"
            if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "IMAGE_TAG=$TAG" >> $GITHUB_OUTPUT
              echo "is_valid=true" >> $GITHUB_OUTPUT
            else
              echo "::error title=Invalid Pushed Tag::Pushed tag $TAG failed semver validation." >&2
              echo "is_valid=false" >> $GITHUB_OUTPUT
            fi
          fi
      - name: Abort on invalid tag
        if: steps.select_tag.outputs.is_valid != 'true'
        run: |
          echo "::error title=Build Aborted::Invalid or missing semver tag; failing build job." >&2
          exit 1
      - name: Configure AWS Credentials
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: aws-actions/configure-aws-credentials@v5.0.0
        with:
          aws-region: us-gov-west-1
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          role-duration-seconds: 900
          role-session-name: vsp-vagov-next-build-githubaction
      - name: Login to Amazon ECR
        if: steps.select_tag.outputs.is_valid == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Get last Apache image tag
        if: steps.select_tag.outputs.is_valid == 'true'
        id: get_last_apache_tag
        run: |
          set -e
          REPO_NAME="dsva/cms-apache"
          echo "Retrieving semver tags from ECR repository $REPO_NAME..."
          IMAGES_JSON=$(aws ecr describe-images --repository-name "$REPO_NAME" --query 'imageDetails' --output json || echo '[]')
          SEMVER_TAG=$(echo "$IMAGES_JSON" | jq -r '
            [ .[]
              | .imageTags? // []
              | .[]
              | select(test("^[0-9]+\.[0-9]+\.[0-9]+$")) ]
            | map({raw: ., parts: (split(".") | map(tonumber))})
            | sort_by(.parts[0], .parts[1], .parts[2])
            | last.raw // empty
          ')
          if [ -z "$SEMVER_TAG" ]; then
            echo "::error title=No Base Image Found::No semver Apache base image tags found in ECR repository $REPO_NAME." >&2
            exit 1
          fi
          # Double-check the tag is retrievable
          if ! aws ecr batch-get-image --repository-name "$REPO_NAME" --image-ids imageTag="$SEMVER_TAG" --query 'images[0].imageId.imageTag' --output text >/dev/null 2>&1; then
            echo "::error title=Base Image Missing::Tag $SEMVER_TAG could not be retrieved from $REPO_NAME." >&2
            exit 1
          fi
          echo "Selected Apache base semver tag: $SEMVER_TAG"
          echo "LAST_TAG=$SEMVER_TAG" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: docker/setup-buildx-action@v3
      - name: Build and push Docker image
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          file: ./Dockerfile
          push: true
          provenance: false
          tags: ${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:${{ steps.select_tag.outputs.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:cache
          cache-to: type=registry,mode=max,image-manifest=true,oci-mediatypes=true,ref=${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:cache
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BASE_IMAGE_TAG=${{ env.LAST_TAG }}
            DD_GIT_COMMIT_SHA=${{ github.sha }}
      # Fail the job if the tag is invalid, to avoid silent skipping of deployment
      - name: Fail if tag is invalid
        if: steps.select_tag.outputs.is_valid != 'true'
        run: |
          echo "ERROR: The provided tag is invalid. Failing the build-and-push job."
          exit 1
  deploy-to-staging:
    needs: build-and-push
    if: needs.build-and-push.outputs.IS_VALID == 'true' && needs.build-and-push.outputs.IMAGE_TAG != ''
    uses: department-of-veterans-affairs/va.gov-cms/.github/workflows/update-manifest.yml@main
    with:
      image_tag: ${{ needs.build-and-push.outputs.IMAGE_TAG }}
      app_name: cms-mirror
      environment: staging
