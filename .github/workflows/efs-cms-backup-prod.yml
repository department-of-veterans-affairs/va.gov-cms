name: CMS EFS Backup Production

on:
  schedule:
    - cron: "0 */6 * * 1-5"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  region: us-gov-west-1
  S3EfsBackupPath: files

jobs:
  backup:
    runs-on: self-hosted
    container:
      image: ubuntu:24.04
      options: --privileged
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          aws-region: ${{ env.region }}

      - name: Install required packages
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y nfs-common ca-certificates python3-pip
          pip3 install --break-system-packages awscli

      - name: Mount EFS and create backup
        run: |
          set -e

          timestamp=$(date "+%Y-%m-%d-%H-%M")
          efs_mount_dir="/tmp/cms-files-mount"
          
          echo "TIMESTAMP=${timestamp}" >> $GITHUB_ENV

          efs_ip=$(aws ssm get-parameter \
            --name "/cms/prod/efs_ips" \
            --with-decryption \
            --region ${{ env.region }} \
            --query 'Parameter.Value' \
            --output text)

          mkdir -p ${efs_mount_dir}
          chmod 755 ${efs_mount_dir}

          mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,ro ${efs_ip}:/ ${efs_mount_dir}

          tar -czf /tmp/${timestamp}-cms-prod-files-latest.tgz \
            --warning=no-file-changed \
            --exclude='.htaccess' \
            --exclude='php' \
            --exclude='css' \
            --exclude='js' \
            --exclude='./export-content' \
            --exclude='./export-files' \
            --exclude='./xmlsitemap' \
            -C ${efs_mount_dir} . || ([ $? -eq 1 ] && echo "Tar completed with warnings (files changed during backup)" && exit 0)

          umount ${efs_mount_dir}
          rm -rf ${efs_mount_dir}

      - name: Refresh AWS credentials before upload
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          aws-region: ${{ env.region }}

      - name: Upload backup to S3
        run: |
          set -e
          
          timestamp=${{ env.TIMESTAMP }}

          s3_backup_bucket=$(aws ssm get-parameter \
            --name "/cms/prod/s3-efs-backup-bucket" \
            --region ${{ env.region }} \
            --query 'Parameter.Value' \
            --output text)

          aws s3 cp /tmp/${timestamp}-cms-prod-files-latest.tgz s3://${s3_backup_bucket}/${{ env.S3EfsBackupPath }}/prod_cmsapp_files_${timestamp}.tgz --region ${{ env.region }} --quiet

          aws s3 cp s3://${s3_backup_bucket}/${{ env.S3EfsBackupPath }}/prod_cmsapp_files_${timestamp}.tgz s3://${s3_backup_bucket}/${{ env.S3EfsBackupPath }}/cms-prod-files-latest.tgz --region ${{ env.region }} --quiet
                    
          echo "s3://${s3_backup_bucket}/${{ env.S3EfsBackupPath }}/cms-prod-files-latest.tgz" > latest_uri

          aws s3 cp latest_uri s3://${s3_backup_bucket}/${{ env.S3EfsBackupPath }}/latest_uri --region ${{ env.region }} --quiet

          rm -f /tmp/${timestamp}-cms-prod-files-latest.tgz