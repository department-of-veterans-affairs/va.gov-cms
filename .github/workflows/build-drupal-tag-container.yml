---
name: Build and Push Drupal Tag Container to ECR

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Semver tag (vX.Y.Z) to build. Leave blank to use latest.'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'  # Only tags starting with v and containing two dots
env:
  CMS_NOTIFICATIONS_SLACK: CJT90C0UT # cms-notifications

# Add concurrency to prevent parallel executions
concurrency:
  group: drupal-mirror-container-build
  cancel-in-progress: false

permissions:
  id-token: write  # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.select_tag.outputs.IMAGE_TAG }}
      IS_VALID: ${{ steps.select_tag.outputs.is_valid }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Needed to list all tags for manual runs
          fetch-tags: true  # Ensure semver tags are available for selection
      - name: Select and validate tag
        id: select_tag
        run: |
          set -e
          TAG_PREFIX='cms/'
          SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'

          normalize_input() {
            local raw="$1"
            if [[ "$raw" == ${TAG_PREFIX}* ]]; then
              echo "${raw#${TAG_PREFIX}}"
            else
              echo "$raw"
            fi
          }

          ensure_tag_exists() {
            local semver="$1"
            git rev-parse -q --verify "refs/tags/${TAG_PREFIX}${semver}" >/dev/null
          }

          EVENT='${{ github.event_name }}'
          INPUT_TAG='${{ github.event.inputs.tag }}'
          if [ "$EVENT" = "workflow_dispatch" ]; then
            if [ -n "$INPUT_TAG" ]; then
              SEMVER_TAG=$(normalize_input "$INPUT_TAG")
              if [[ "$SEMVER_TAG" =~ $SEMVER_REGEX ]]; then
                if ensure_tag_exists "$SEMVER_TAG"; then
                  echo "IMAGE_TAG=$SEMVER_TAG" >> $GITHUB_OUTPUT
                  echo "is_valid=true" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "::error title=Invalid Tag::Provided tag ${TAG_PREFIX}$SEMVER_TAG does not exist in repository." >&2
                  echo "is_valid=false" >> $GITHUB_OUTPUT
                  exit 1
                fi
              else
                echo "::error title=Invalid Semver::Provided tag $INPUT_TAG is not strict semver vX.Y.Z (prefix ${TAG_PREFIX} optional)." >&2
                echo "is_valid=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              LATEST_TAG=$(git tag --list "${TAG_PREFIX}v*.*.*" --sort=-version:refname | head -n1)
              if [ -z "$LATEST_TAG" ]; then
                echo "::error title=No Tags Found::No prefixed semver tags (${TAG_PREFIX}vX.Y.Z) found in repository." >&2
                echo "is_valid=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              SEMVER_TAG="${LATEST_TAG#${TAG_PREFIX}}"
              if [[ ! "$SEMVER_TAG" =~ $SEMVER_REGEX ]]; then
                echo "::error title=Invalid Tag Format::Latest tag $LATEST_TAG does not match expected semver pattern after removing prefix." >&2
                echo "is_valid=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              echo "Using latest semver tag: $SEMVER_TAG (repo tag $LATEST_TAG)"
              echo "IMAGE_TAG=$SEMVER_TAG" >> $GITHUB_OUTPUT
              echo "is_valid=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            RAW_TAG="$GITHUB_REF_NAME"
            SEMVER_TAG=$(normalize_input "$RAW_TAG")
            if [[ "$SEMVER_TAG" =~ $SEMVER_REGEX ]]; then
              echo "IMAGE_TAG=$SEMVER_TAG" >> $GITHUB_OUTPUT
              echo "is_valid=true" >> $GITHUB_OUTPUT
            else
              echo "::error title=Invalid Pushed Tag::Pushed tag $RAW_TAG failed semver validation after removing prefix." >&2
              echo "is_valid=false" >> $GITHUB_OUTPUT
            fi
          fi
      - name: Abort on invalid tag
        if: steps.select_tag.outputs.is_valid != 'true'
        run: |
          echo "::error title=Build Aborted::Invalid or missing semver tag; failing build job." >&2
          exit 1
      - name: Configure AWS Credentials
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: aws-actions/configure-aws-credentials@v5.0.0
        with:
          aws-region: us-gov-west-1
          role-to-assume: ${{ vars.AWS_ASSUME_ROLE }}
          role-duration-seconds: 900
          role-session-name: vsp-vagov-next-build-githubaction
      - name: Login to Amazon ECR
        if: steps.select_tag.outputs.is_valid == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Get last Apache image tag
        if: steps.select_tag.outputs.is_valid == 'true'
        id: get_last_apache_tag
        run: |
          set -e
          REPO_NAME="dsva/cms-apache"
          echo "Retrieving semver tags from ECR repository $REPO_NAME..."
          IMAGES_JSON=$(aws ecr describe-images --repository-name "$REPO_NAME" --query 'imageDetails' --output json || echo '[]')
          SEMVER_TAG=$(echo "$IMAGES_JSON" | jq -r '
            [ .[]
              | .imageTags? // []
              | .[]
              | select(test("^[0-9]+\.[0-9]+\.[0-9]+$")) ]
            | map({raw: ., parts: (split(".") | map(tonumber))})
            | sort_by(.parts[0], .parts[1], .parts[2])
            | last.raw // empty
          ')
          if [ -z "$SEMVER_TAG" ]; then
            echo "::error title=No Base Image Found::No semver Apache base image tags found in ECR repository $REPO_NAME." >&2
            exit 1
          fi
          # Double-check the tag is retrievable
          if ! aws ecr batch-get-image --repository-name "$REPO_NAME" --image-ids imageTag="$SEMVER_TAG" --query 'images[0].imageId.imageTag' --output text >/dev/null 2>&1; then
            echo "::error title=Base Image Missing::Tag $SEMVER_TAG could not be retrieved from $REPO_NAME." >&2
            exit 1
          fi
          echo "Selected Apache base semver tag: $SEMVER_TAG"
          echo "LAST_TAG=$SEMVER_TAG" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: docker/setup-buildx-action@v3
      - name: Build and push Docker image
        if: steps.select_tag.outputs.is_valid == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          file: ./Dockerfile
          push: true
          provenance: false
          tags: ${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:${{ steps.select_tag.outputs.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:cache
          cache-to: type=registry,mode=max,image-manifest=true,oci-mediatypes=true,ref=${{ steps.login-ecr.outputs.registry }}/dsva/cms-drupal:cache
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            BASE_IMAGE_TAG=${{ env.LAST_TAG }}
            DD_GIT_COMMIT_SHA=${{ github.sha }}
